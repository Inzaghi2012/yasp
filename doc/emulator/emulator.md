# Emulator
The emulator executes the bitcode generated by the assembler.

## Ticks
The emulator works in ticks. Each [`tick()`](http://doc.yasp.me/yasp.Emulator.html#tick) executes one instruction,
which is fetched from the rom. Ticks executed by the [`tickWrapper()`](http://doc.yasp.me/yasp.Emulator.html#tickWrapper),
which is invoked by a simple `setTimeout`. Because there is a limit on how frequent `setTimeout` can fire, a number of
ticks is executed in each `tickWrapper()`-call.

1. [`tickWrapper()`](http://doc.yasp.me/yasp.Emulator.html#tickWrapper)
  1. check if the emulator is running, if not, exit
  2. check if the number of instructions to be executed has been executed, if yes, exit (see [`CONTINUE`-Message](./messages.md#message-continue))
  3. check if the emulator should be waiting (`PAUSE` or `DELAY` executed), if yes, set a timeout of the desired time and exit.
     This is skipped if the emulator is stepping.
  4. [`tick()`](http://doc.yasp.me/yasp.Emulator.html#tickWrapper)
    1. check for interrupts
    2. fetch the next instruction from the ROM
      1. check if the instruction is cached, if not disassemble and cache
      2. fetch instruction from the cache
    3. load needed values for parameters
    4. call the `exec()`-function of the instruction
    5. check and set the zero-flag, if specified in instruction-file
2. [`setTickWrapperTimeout()`](http://doc.yasp.me/yasp.Emulator.html#setTickWrapperTimeout)

The timeout which is set by `setTickWrapperTimeout()` can be interrupted by a number of things:
* `CONTINUE`-message (to allow faster stepping)
* Hardware-Interrupt

In addition the timeout will be longer when the `emulator.waitTime` (see `DELAY`-instruction) is set.

## PWM
The emulator is capable of simulating PWM, in terms of calculating a pins analogue output power when a pin is rapidly
switched on and off. This is done in the [`updatePwm()`](http://doc.yasp.me/yasp.Emulator.html#updatePwm) helper function.
Note that this behaviour only used when the pins state changes more often than 10 times a second, otherwise the state
of the pin will always be `1` or `0`. PWM causes the state to be between `1` and `255`.

```
 Impulse
     +--+
     |  |
   --+  +------------------


 Pulse
     +--+  +--+  +--+  +--+  +--+
     |  |  |  |  |  |  |  |  |  |
   --+  +--+  +--+  +--+  +--+  +--

 Pulse width modulation
     t   t
      on  off
     <--><-->
     +---+  +---+  +---+  +---+  +-- ...
     |   |  |   |  |   |  |   |  |
   --+   +--+   +--+   +--+   +--+
     |<---->|<---->|<---->|<---->|
       t
        const

    t   +  t     = t
     on     off     const

 Calculation of the output power

     1234566789
     +---+  +---+  +---+  +---+  +-- ...
     |   |  |   |  |   |  |   |  |
   --+   +--+   +--+   +--+   +--+

    startOn1 = 1
    startOff = 5
    startOn2 = 7

    t    = startOff - startOn1 = 4
     on

    t    = startOff - startOn2 = 2
     off

             t
              on             4       2
    x =  --------------  =  ---  =  ---  = 66.66%
          t    +  t          6       3
           off     on
```

## Stack
The is located in the RAM, beginning from `0x50`. The `sp` gets increment before the byte is pushed (pre-increment), so
the `sp` always points to the last byte. Words are pushed with the least significant byte first.
An example can be found in the [tutorial](../tutorial.md).

## [Data](./data.md)
Data structures which are used inside the emulator and its messages and broadcasts.

## [Messages](./messages.md)
Details about the [Communicator](../communicator.md)-Implementation for the emulator, including the messages and broadcasts.
