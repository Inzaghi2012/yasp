<!doctype html>
<html>
<head>
    <title>yasp repl</title>

    <meta charset="utf-8">

    <script src="../../lib/js/jquery-1.10.2.min.js"></script>
    <script src="../js/commands.js"></script>
    <script src="../js/utils.js"></script>
</head>
<body>
<script src="../js/assembler/assembler.js"></script>
<script src="../js/assembler/passes/lexer.js"></script>
<script src="../js/assembler/passes/analyser.js"></script>
<script src="../js/assembler/passes/parser.js"></script>
<script src="../js/assembler/passes/generator.js"></script>
<script src="../js/emulator/bitutils.js"></script>
<script src="../js/emulator/emulator.js"></script>

Input: <input id="foo"><br>
Times: <input id="times" value="1"> => <span id="timeTakenMs"></span> => <span id="timeTakenHz"></span>
<pre id="bitcode">&nbsp;</pre>
<pre id="mem"></pre>

<script type="text/javascript">
    var assembler = new yasp.Assembler();
    var emulator = new yasp.Emulator();
    emulator.stepping = true;

    dumpRam();

    $('#foo').bind('keypress', function(e) {
        if(e.keyCode==13){
            var code = $('#foo').val();
            $('#foo').val("");
            var asm = assembler.assemble({ code: code, jobs: ["bitcode"] });
            console.log(asm);

            if(asm.success != false) {
                emulator.load(asm.bitcode, 0);

                var times = +$('#times').val() || 1;
                var start = +new Date();

                for (var i = 0; i < times; i++) {
                    emulator.pc = 0;
                    emulator.tick();
                }

                var end = +new Date();
                var taken = end - start;
                $('#timeTakenMs').text(taken + "ms");
                $('#timeTakenHz').text(Math.round((1 / (taken / times)) * 10) / 10 + "Hz");

                dumpRam();
                $('#bitcode').text(getDump(asm.bitcode, -1));
            } else {
                var error = "";
                for (var i = 0; i < asm.errors.length; i++) {
                    error += asm.errors[i].message.replace('\n', 'â†µ');
                }
                $('#bitcode').text(error);
            }
        }
    });

    function dumpRam () {
        $('#mem').text(getDump(emulator.ram, 20));
    }

    function getDump (data, b) {
        var dmp = "";
        for (var i = 0; i < data.length; i++) {
            if(b != -1 && i % 20 == 0)
                dmp += "\n";
            var d = data[i].toString(16);
            if(d.length == 1)
                d = "0" + d;
            dmp += "0x" + d + " ";
        }
        return dmp;
    }
</script>
</body>
</html>
